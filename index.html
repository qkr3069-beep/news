<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë°ì¼ë¦¬ ë‰´ìŠ¤ ë¸Œë¦¬í•‘ Â· v2.1R-REBUILD</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .skeleton{position:relative;overflow:hidden;background:#e5e7eb}
    .skeleton::after{content:"";position:absolute;inset:0;transform:translateX(-100%);
      background:linear-gradient(90deg,rgba(229,231,235,0) 0,rgba(255,255,255,.7) 50%,rgba(229,231,235,0) 100%);
      animation:shimmer 1.2s infinite}
    @keyframes shimmer{100%{transform:translateX(100%)}}
    .badge{font-size:.65rem;padding:.2rem .5rem;border-radius:9999px;border:1px solid rgba(0,0,0,.08)}
    .card{border:1px solid rgb(229 231 235); border-radius:1rem; background:white; padding:1.25rem}
    .section-title{font-weight:600; font-size:1.125rem; margin-bottom:.75rem}
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-7xl mx-auto p-4 sm:p-8">

    <!-- ë©”ì¸ ë°°ë„ˆ: ì´ë¯¸ì§€ srcë§Œ ë°”ê¾¸ì„¸ìš” -->
    <a href="https://omnicare.biz/main/index.php?utm_source=omnicare&utm_medium=news&utm_campaign=daily"
       target="_blank" rel="noopener"
       class="relative block rounded-2xl overflow-hidden border border-gray-200 shadow-sm mb-6"
       aria-label="ë¹„íƒ€ë¸Œë¦¿ì§€ ê±´ê°•ê²€ì§„ ì˜ˆì•½ ë°”ë¡œê°€ê¸°">
      <img src="https://postfiles.pstatic.net/MjAyNTA5MDVfMjU2/MDAxNzU3MDM1MzI5ODQ1.uqf71crOiDQYlLsoFGuIKzlASSUil46DsxNDebXlBcYg.wBc6WmhjLSfYDp6xPIF5sznkh50XOkMy-xq0k9GMTV8g.PNG/%EC%98%B4%EB%8B%88%EC%BC%80%EC%96%B4_%EB%A1%9C%EA%B3%A0.png?type=w966"
           alt="ê±´ê°•ê²€ì§„ ì˜ˆì•½ì€ ë¹„íƒ€ë¸Œë¦¿ì§€"
           class="w-full h-40 sm:h-56 md:h-64 object-cover" />
      <div class="pointer-events-none absolute inset-0 flex items-end">
        <div class="m-4 px-3 py-1.5 rounded-full bg-white/90 text-gray-900 text-xs font-medium shadow">
          ê±´ê°•ê²€ì§„ ì˜ˆì•½ì€ ë¹„íƒ€ë¸Œë¦¿ì§€
        </div>
      </div>
    </a>

    <!-- í—¤ë”/ì»¨íŠ¸ë¡¤ -->
    <header class="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
      <div>
        <h1 class="text-3xl font-semibold tracking-tight">ë°ì¼ë¦¬ ë‰´ìŠ¤ ë¸Œë¦¬í•‘ <span class="text-xs align-super text-indigo-600">v2.1R-REBUILD</span></h1>
        <p class="text-sm text-gray-500">í—¬ìŠ¤ì¼€ì–´ + ì‚¬íšŒÂ·ê²½ì œÂ·ê¸°ìˆ Â·ê¸€ë¡œë²Œ ì´ìŠˆ. (Recall ìš°ì„  Â· KST ë¡¤ë§ ìœˆë„ìš°)</p>
      </div>
      <div class="flex flex-wrap items-center gap-3">
        <input id="dateInput" type="date" class="px-3 py-2 rounded-xl border border-gray-300 bg-white text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" />
        <input id="keywordInput" type="text" placeholder="ê²€ìƒ‰ í‚¤ì›Œë“œ (ì˜ˆ: ê±°ë˜ì²˜/ì œí’ˆ/ì¸ë¬¼)" class="px-3 py-2 rounded-xl border border-gray-300 bg-white text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 w-44 sm:w-64" />
        <div class="flex items-center gap-2 text-sm">
          <label class="inline-flex items-center gap-1"><input id="toggleBusiness" type="checkbox" class="rounded" checked> ì‚¬ì—…ì²´</label>
          <label class="inline-flex items-center gap-1"><input id="toggleGov" type="checkbox" class="rounded" checked> êµ­ê°€ê¸°ê´€</label>
          <label class="inline-flex items-center gap-1"><input id="applyKeywordTop" type="checkbox" class="rounded"> Top Storiesì— í‚¤ì›Œë“œ ì ìš©</label>
          <label class="inline-flex items-center gap-1"><input id="applyKeywordGov" type="checkbox" class="rounded" checked> ê¸°ê´€ì— í‚¤ì›Œë“œ ì ìš©</label>
        </div>
        <button id="fetchBtn" class="px-4 py-2 rounded-xl bg-indigo-600 text-white text-sm font-medium hover:bg-indigo-700">ë¸Œë¦¬í•‘ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button id="exportBtn" class="px-4 py-2 rounded-xl bg-gray-800 text-white text-sm font-medium hover:bg-gray-900">Markdown ë‚´ë³´ë‚´ê¸°</button>
      </div>
    </header>

    <section id="meta" class="mt-4 text-sm text-gray-600"></section>

    <!-- âœ… ì„¹ì…˜ì„ HTMLì— ë¯¸ë¦¬ ë°•ì•„ë‘ : JSëŠ” ë‚´ìš©ë§Œ ì±„ì›€ -->
    <main id="results" class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
      <section id="sec-gTop" class="card"><h2 class="section-title">ğŸ—ï¸ Google Top Stories(ko/en)</h2><div class="space-y-3"><div class="h-5 rounded skeleton"></div><div class="h-5 rounded skeleton"></div><div class="h-5 rounded skeleton"></div></div></section>
      <section id="sec-top"  class="card"><h2 class="section-title">ğŸ”¥ Top Stories (ê¸€ë¡œë²Œ ë³´ì •)</h2><div class="space-y-3"><div class="h-5 rounded skeleton"></div><div class="h-5 rounded skeleton"></div><div class="h-5 rounded skeleton"></div></div></section>

      <section id="sec-healthcare" class="card"><h2 class="section-title">1) í—¬ìŠ¤ì¼€ì–´Â·ì˜ë£Œ ì‚°ì—…</h2><div class="space-y-3"><div class="h-5 rounded skeleton"></div><div class="h-5 rounded skeleton"></div><div class="h-5 rounded skeleton"></div></div></section>
      <section id="sec-economy"    class="card"><h2 class="section-title">2) ê²½ì œÂ·ê²½ì˜ íŠ¸ë Œë“œ</h2><div class="space-y-3"><div class="h-5 rounded skeleton"></div><div class="h-5 rounded skeleton"></div><div class="h-5 rounded skeleton"></div></div></section>

      <section id="sec-society"   class="card"><h2 class="section-title">3) ì‚¬íšŒÂ·ë¬¸í™” ì´ìŠˆ</h2><div class="space-y-3"><div class="h-5 rounded skeleton"></div><div class="h-5 rounded skeleton"></div><div class="h-5 rounded skeleton"></div></div></section>
      <section id="sec-tech"      class="card"><h2 class="section-title">4) ê¸°ìˆ Â·ë””ì§€í„¸ íŠ¸ë Œë“œ</h2><div class="space-y-3"><div class="h-5 rounded skeleton"></div><div class="h-5 rounded skeleton"></div><div class="h-5 rounded skeleton"></div></div></section>

      <section id="sec-global"    class="card"><h2 class="section-title">5) ê¸€ë¡œë²Œ ì´ìŠˆ</h2><div class="space-y-3"><div class="h-5 rounded skeleton"></div><div class="h-5 rounded skeleton"></div><div class="h-5 rounded skeleton"></div></div></section>

      <section id="sec-officialsKR" class="card"><h2 class="section-title">ğŸ›ï¸ êµ­ë‚´ ê³µì‹ ë ¥ ì†ŒìŠ¤(ê¸°ê´€ ë°œí‘œ)</h2><div class="space-y-3"><div class="h-5 rounded skeleton"></div><div class="h-5 rounded skeleton"></div><div class="h-5 rounded skeleton"></div></div></section>
      <section id="sec-officials"   class="card"><h2 class="section-title">ğŸŒ í•´ì™¸ ê³µì‹ ë ¥ ì†ŒìŠ¤(ê¸°ê´€ ë°œí‘œ)</h2><div class="space-y-3"><div class="h-5 rounded skeleton"></div><div class="h-5 rounded skeleton"></div><div class="h-5 rounded skeleton"></div></div></section>
    </main>

    <aside class="mt-8 grid grid-cols-1 lg:grid-cols-3 gap-4 text-xs text-gray-500">
      <div class="card">
        <div class="font-semibold mb-1">ë²„ì „ ë…¸íŠ¸</div>
        <ul class="list-disc ml-4 space-y-1">
          <li>ì„¹ì…˜ì„ HTMLì— <b>ê³ ì • ë Œë”</b> â†’ JS ì‹¤íŒ¨/ì§€ì—° ì‹œì—ë„ ì¹´ë“œê°€ í•­ìƒ ë³´ì„</li>
          <li>v2.1 ë°©ì‹(Recall) + <b>description í¬í•¨</b> í‚¤ì›Œë“œ ë§¤ì¹­</li>
          <li>ì „ì¼ 15:00 ~ ë‹¹ì¼ 14:59 (KST) ë¡¤ë§ ìœˆë„ìš°</li>
          <li>ì„¸ì´í”„í‹°: ìºì‹œ(5ë¶„) Â· íƒ€ì„ì•„ì›ƒ Â· í”„ë¡ì‹œ í´ë°± Â· ë¶€ë¶„ ì‹¤íŒ¨ ë¬´ì‹œ</li>
        </ul>
      </div>
      <div class="card">
        <div class="font-semibold mb-1">ë°ì´í„° ì†ŒìŠ¤</div>
        <p>Google News RSS(ko, en-US, en-GB), Google Top Stories, WHO/FDA/EMA/CDC/ACOG/SMFM, êµ­ë‚´: ë²•ì œì²˜Â·ë³´ê±´ë³µì§€ë¶€Â·ì‹ì•½ì²˜Â·ì§ˆë³‘ê´€ë¦¬ì²­.</p>
      </div>
      <div class="card">
        <div class="font-semibold mb-1">Tip</div>
        <p>ê¸°ê´€ RSS ì£¼ì†Œê°€ ë°”ë€Œë©´ ì½”ë“œ ìƒë‹¨ feeds ë°°ì—´ì—ì„œ ì—…ë°ì´íŠ¸í•˜ì„¸ìš”.</p>
      </div>
    </aside>
  </div>

  <script>
    /* ---------------- CONFIG ---------------- */
    const CONFIG = {
      maxPerSection: 4,
      languageKO: 'ko', countryKO: 'KR',
      languageEN: 'en', countryUS: 'US', countryGB: 'GB',
      globalQueries: [
        'acetaminophen OR paracetamol OR Tylenol OR autism OR ASD OR pregnancy OR Trump',
        'AI health OR medical AI OR digital therapeutics OR wearable health',
        'vaccine safety OR adverse events OR FDA warning OR EMA safety'
      ],
      categories: [
        { id: 'healthcare', el: 'sec-healthcare',
          queriesKO: ['ì›ê²©ì˜ë£Œ OR ë””ì§€í„¸ ì¹˜ë£Œì œ OR DTx','ë³´ê±´ì˜ë£Œ ì •ì±… OR ê±´ê°•ë³´í—˜ OR ê¸‰ì—¬í™”','ì œì•½ë°”ì´ì˜¤ FDA OR ì„ìƒ ìŠ¹ì¸ OR í—ˆê°€'],
          queriesEN: ['telemedicine OR digital therapeutics OR DTx','health policy OR reimbursement OR payer','biotech FDA approval OR clinical trial OR authorization'] },
        { id: 'economy', el: 'sec-economy',
          queriesKO: ['ê¸°ì¤€ê¸ˆë¦¬ OR ê¸ˆë¦¬ ë™ê²° OR ì¸í•˜ OR ì¸ìƒ','í™˜ìœ¨ OR ì™¸í™˜ì‹œì¥ OR ìˆ˜ì¶œì…','M&A OR ìŠ¤íƒ€íŠ¸ì—… íˆ¬ì OR ë²¤ì²˜ìºí”¼í„¸'],
          queriesEN: ['interest rate OR central bank decision','FX market OR exchange rate','M&A OR venture capital OR startup funding'] },
        { id: 'society', el: 'sec-society',
          queriesKO: ['ê³ ë ¹í™” OR 1ì¸ ê°€êµ¬ OR ì €ì¶œì‚°','ì›°ë¹™ OR ë‹¤ì´ì–´íŠ¸ íŠ¸ë Œë“œ OR í”¼íŠ¸ë‹ˆìŠ¤','MZì„¸ëŒ€ ê±´ê°• OR ë””ì§€í„¸ í—¬ìŠ¤ ì†Œë¹„'],
          queriesEN: ['ageing population OR low birth rate','wellness trend OR fitness culture','consumer health app adoption'] },
        { id: 'tech', el: 'sec-tech',
          queriesKO: ['ìƒì„±í˜• AI OR AI ë„ì… íš¨ê³¼ OR ìë™í™”','ì˜ë£Œ ë°ì´í„° ë³´ì•ˆ OR ê°œì¸ì •ë³´ë³´í˜¸ OR GDPR','ì›¨ì–´ëŸ¬ë¸” OR ì• í”Œì›Œì¹˜ OR ë””ì§€í„¸ í—¬ìŠ¤'],
          queriesEN: ['generative AI OR automation in healthcare','health data security OR HIPAA OR GDPR','wearable health OR Apple Watch OR remote monitoring'] },
        { id: 'global', el: 'sec-global',
          queriesKO: ['ê³µê¸‰ë§ ë¦¬ìŠ¤í¬ OR ì›ìì¬ OR API ë¶€ì¡±','ê¸°í›„ ë³€í™” ê±´ê°• ì˜í–¥ OR í­ì—¼ ê±´ê°•','ë¶„ìŸ OR ì§€ì •í•™ OR íŒ¬ë°ë¯¹ ì´í›„'],
          queriesEN: ['supply chain risk OR API shortage','climate change health impact OR heat wave health','geopolitics OR conflict OR post-pandemic'] },
      ],
      officialFeedsGlobal: [
        { name: 'WHO News', url: 'https://www.who.int/feeds/entity/mediacentre/news/en/rss.xml' },
        { name: 'FDA Press', url: 'https://www.fda.gov/about-fda/contact-fda/press-announcements?rss=1' },
        { name: 'EMA News', url: 'https://www.ema.europa.eu/en/news_events/news?output=rss' },
        { name: 'CDC Newsroom', url: 'https://tools.cdc.gov/api/v2/resources/media/403372.rss' },
        { name: 'ACOG News', url: 'https://www.acog.org/News/news-articles?rss=1' },
        { name: 'SMFM Statements', url: 'https://www.smfm.org/rss' },
      ],
      officialFeedsKR: [
        { name: 'ë²•ì œì²˜ ë³´ë„ìë£Œ', url: 'https://www.moleg.go.kr/news/rss' },
        { name: 'ë³´ê±´ë³µì§€ë¶€ ë³´ë„ìë£Œ', url: 'https://www.mohw.go.kr/rss/press.xml' },
        { name: 'ì‹ì•½ì²˜ ë³´ë„ìë£Œ', url: 'https://www.mfds.go.kr/brd/m_99/rss.do' },
        { name: 'ì§ˆë³‘ê´€ë¦¬ì²­ ë³´ë„ìë£Œ', url: 'https://www.kdca.go.kr/board/rss/boardRss.es?bid=0015' },
      ],
    };

    /* ---------------- UTILS ---------------- */
    const CACHE_TTL_MS = 5 * 60 * 1000;
    function toKST(d){ return new Date(d.getTime() + (9*60 + d.getTimezoneOffset())*60000); }
    function toLocalKSTDateString(d){ return toKST(d).toISOString().slice(0,10); }
    function formatTimeKST(d){ d=toKST(d); const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),dy=String(d.getDate()).padStart(2,'0'),hh=String(d.getHours()).padStart(2,'0'),mm=String(d.getMinutes()).padStart(2,'0'); return `${y}-${m}-${dy} ${hh}:${mm} KST`; }
    function sanitize(s){ const el=document.createElement('div'); el.textContent=s??''; return el.innerHTML; }
    function getHostname(u){ try{return new URL(u).hostname.replace(/^www\./,'')}catch{return ''} }
    function dedupe(items){ const seen=new Set(); return items.filter(it=>{ const k=(getHostname(it.link)+'|'+it.title).toLowerCase(); if(seen.has(k)) return false; seen.add(k); return true; }); }

    // ì „ì¼ 15:00 ~ ë‹¹ì¼ 14:59 (KST)
    function inWindow(pubDate, targetDateStr){
      if(!(pubDate instanceof Date) || isNaN(pubDate)) return false;
      const pivot = new Date(`${targetDateStr}T15:00:00+09:00`);
      const start = new Date(pivot.getTime() - 24*60*60*1000);
      const end   = new Date(pivot.getTime() - 1000);
      return pubDate >= start && pubDate <= end;
    }

    function getCache(key){ try{ const v=sessionStorage.getItem(key); if(!v) return null; const {t,data}=JSON.parse(v); if(Date.now()-t<CACHE_TTL_MS) return data; }catch{} return null; }
    function setCache(key,data){ try{ sessionStorage.setItem(key, JSON.stringify({t:Date.now(),data})); }catch{} }

    function fetchWithTimeout(url, ms=6000, opts={}){ const ctrl=new AbortController(); const id=setTimeout(()=>ctrl.abort(),ms); return fetch(url,{...opts,signal:ctrl.signal}).finally(()=>clearTimeout(id)); }
    async function fetchViaProxies(url){
      const cacheKey=`rss:${url}`; const cached=getCache(cacheKey); if(cached) return cached;
      const targets=[
        `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}&nocache=${Date.now()}`,
        `https://cors.isomorphic-git.org/${url}`,
        `https://thingproxy.freeboard.io/fetch/${url}`
      ];
      let lastErr;
      for(const t of targets){
        try{ const r=await fetchWithTimeout(t,6000); if(!r.ok) throw new Error(`${r.status}`); const text=await r.text(); setCache(cacheKey,text); return text; }
        catch(e){ lastErr=e; }
      }
      throw lastErr||new Error('proxy failed');
    }

    function googleNewsRSS(q,lang,country){ const base='https://news.google.com/rss/search'; const p=new URLSearchParams({q,hl:lang,gl:country,ceid:`${country}:${lang}`}); return `${base}?${p.toString()}`; }
    function googleTopStoriesRSS(lang,country){ const base='https://news.google.com/rss'; const p=new URLSearchParams({hl:lang,gl:country,ceid:`${country}:${lang}`}); return `${base}?${p.toString()}`; }

    /* ---------------- RENDER HELPERS ---------------- */
    function setSectionLoading(id){ const el=document.getElementById(id); if(!el) return; el.querySelector(':scope > div').innerHTML =
      '<div class="space-y-3"><div class="h-5 rounded skeleton"></div><div class="h-5 rounded skeleton"></div><div class="h-5 rounded skeleton"></div></div>'; }

    function renderItems(id, items){
      const el=document.getElementById(id);
      if(!el) return;
      const box = el.querySelector(':scope > div');
      if(!items || !items.length){
        box.innerHTML = '<p class="text-sm text-gray-500">í•´ë‹¹ ì¡°ê±´ì— ë§ëŠ” ê¸°ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }
      const html = items.slice(0, CONFIG.maxPerSection).map(it=>(
        `<a href="${sanitize(it.link)}" target="_blank" rel="noopener" class="block group">
           <div class="p-3 rounded-xl group-hover:bg-gray-50 transition">
             <h3 class="font-medium leading-snug">${sanitize(it.title)}</h3>
             <p class="text-sm text-gray-600 mt-1">${sanitize(it.source)} Â· ${sanitize(formatTimeKST(it.pubDate))} Â· <span class="uppercase">${sanitize(it.lang||'')}</span></p>
           </div>
         </a>`
      )).join('');
      box.innerHTML = `<div class="divide-y">${html}</div>`;
    }

    /* ---------------- PARSE ---------------- */
    async function parseRSS(url, langTag){
      try{
        const text=await fetchViaProxies(url);
        const xml=new DOMParser().parseFromString(text,'text/xml');
        if(xml.querySelector('parsererror')) return [];

        let items=[...xml.querySelectorAll('item')].map(x=>({
          title: x.querySelector('title')?.textContent?.trim() || '',
          link: x.querySelector('link')?.textContent?.trim() || '',
          description: x.querySelector('description')?.textContent || '',
          pubDateRaw: x.querySelector('pubDate')?.textContent?.trim()
                   || x.querySelector('dc\\:date')?.textContent?.trim()
                   || x.querySelector('updated')?.textContent?.trim() || '',
          source: x.querySelector('source')?.textContent?.trim()
               || x.querySelector('author')?.textContent?.trim() || 'ì¶œì²˜ ë¯¸ìƒ',
          lang: langTag || ''
        })];

        if(items.length===0){
          items=[...xml.querySelectorAll('entry')].map(e=>{
            const linkEl=e.querySelector('link[rel="alternate"]')||e.querySelector('link');
            return {
              title: e.querySelector('title')?.textContent?.trim()||'',
              link: linkEl?.getAttribute('href')||'',
              description: e.querySelector('summary')?.textContent||'',
              pubDateRaw: e.querySelector('updated')?.textContent?.trim() || e.querySelector('published')?.textContent?.trim() || '',
              source: 'ê³µì‹', lang: langTag||''
            };
          });
        }
        for(const it of items){ const d=new Date(it.pubDateRaw); it.pubDate=isNaN(d)?new Date(0):d; }
        return items;
      }catch{ return []; }
    }

    async function fetchQueries(qs, lang, country, tag, keyword){
      const arr = qs.map(q => keyword ? `${q} ${keyword}` : q);
      const urls = arr.map(q => googleNewsRSS(q, lang, country));
      const settled = await Promise.allSettled(urls.map(u => parseRSS(u, tag)));
      return settled.flatMap(s => s.status==='fulfilled' ? s.value : []);
    }

    async function fetchTopStoriesAll(){
      const feeds=[
        googleTopStoriesRSS(CONFIG.languageKO, CONFIG.countryKO),
        googleTopStoriesRSS(CONFIG.languageEN, CONFIG.countryUS),
        googleTopStoriesRSS(CONFIG.languageEN, CONFIG.countryGB),
      ];
      const settled = await Promise.allSettled(feeds.map(u=>parseRSS(u,'top')));
      return settled.flatMap(s => s.status==='fulfilled' ? s.value : []);
    }

    async function fetchOfficialsKR(){
      const settled = await Promise.allSettled(
        CONFIG.officialFeedsKR.map(f => parseRSS(f.url,'gov').then(items => { items.forEach(i=>i.source=f.name); return items; }))
      );
      return settled.flatMap(s => s.status==='fulfilled' ? s.value : []);
    }
    async function fetchOfficialsGlobal(){
      const settled = await Promise.allSettled(
        CONFIG.officialFeedsGlobal.map(f => parseRSS(f.url,'official').then(items => { items.forEach(i=>i.source=f.name); return items; }))
      );
      return settled.flatMap(s => s.status==='fulfilled' ? s.value : []);
    }

    /* ---------------- FILTER ---------------- */
    function applyFilters(items, dateStr, keyword){
      let arr = items.filter(it => inWindow(it.pubDate, dateStr));
      if(keyword){
        const tokens = keyword.split(/[ ,|]+/).map(s=>s.toLowerCase()).filter(Boolean);
        arr = arr.filter(it => {
          const text = ((it.title||'') + ' ' + (it.description||'')).toLowerCase();
          return tokens.some(t => text.includes(t));
        });
      }
      const cover = new Map();
      for(const it of arr){ const k = it.title.toLowerCase(); cover.set(k,(cover.get(k)||0)+1); }
      return arr.sort((a,b)=>{
        const c = (cover.get(b.title.toLowerCase())||1) - (cover.get(a.title.toLowerCase())||1);
        return c!==0 ? c : (b.pubDate - a.pubDate);
      });
    }

    /* ---------------- RUN ---------------- */
    async function run(){
      // UI ê°’
      const dateStr = document.getElementById('dateInput').value;
      const keyword = document.getElementById('keywordInput').value.trim();
      const includeBiz = document.getElementById('toggleBusiness').checked;
      const includeGov = document.getElementById('toggleGov').checked;
      const kwTop = document.getElementById('applyKeywordTop').checked;
      const kwGov = document.getElementById('applyKeywordGov').checked;

      // ì„¹ì…˜ì„ ë¡œë”© ìƒíƒœë¡œ
      ['sec-gTop','sec-top','sec-healthcare','sec-economy','sec-society','sec-tech','sec-global','sec-officialsKR','sec-officials']
        .forEach(setSectionLoading);

      let totalShown = 0;

      try{
        // Google Top Stories
        if(includeBiz){
          const topAll = await fetchTopStoriesAll();
          const topFiltered = applyFilters(dedupe(topAll), dateStr, kwTop ? keyword : null).slice(0, CONFIG.maxPerSection);
          renderItems('sec-gTop', topFiltered);
          totalShown += topFiltered.length;
        } else {
          renderItems('sec-gTop', []);
        }

        // ê¸€ë¡œë²Œ í•«í† í”½
        if(includeBiz){
          const [hotUS, hotGB] = await Promise.all([
            fetchQueries(CONFIG.globalQueries, CONFIG.languageEN, CONFIG.countryUS, 'en', keyword),
            fetchQueries(CONFIG.globalQueries, CONFIG.languageEN, CONFIG.countryGB, 'en', keyword),
          ]);
          const hot = applyFilters(dedupe([...hotUS, ...hotGB]), dateStr, keyword);
          renderItems('sec-top', hot);
          totalShown += Math.min(hot.length, CONFIG.maxPerSection);
        } else {
          renderItems('sec-top', []);
        }

        // ì¹´í…Œê³ ë¦¬
        if(includeBiz){
          await Promise.all(CONFIG.categories.map(async cat=>{
            const [ko, enUS, enGB] = await Promise.all([
              fetchQueries(cat.queriesKO, CONFIG.languageKO, CONFIG.countryKO, 'ko', keyword),
              fetchQueries(cat.queriesEN, CONFIG.languageEN, CONFIG.countryUS, 'en', keyword),
              fetchQueries(cat.queriesEN, CONFIG.languageEN, CONFIG.countryGB, 'en', keyword),
            ]);
            const merged = dedupe([...ko, ...enUS, ...enGB]);
            const filt = applyFilters(merged, dateStr, keyword);
            renderItems(`sec-${cat.id}`, filt);
            totalShown += Math.min(filt.length, CONFIG.maxPerSection);
          }));
        } else {
          CONFIG.categories.forEach(cat => renderItems(`sec-${cat.id}`, []));
        }

        // ê¸°ê´€
        if(includeGov){
          const offKR = await fetchOfficialsKR();
          renderItems('sec-officialsKR', applyFilters(dedupe(offKR), dateStr, kwGov ? keyword : null));
        } else {
          renderItems('sec-officialsKR', []);
        }
        if(includeGov){
          const offGlobal = await fetchOfficialsGlobal();
          renderItems('sec-officials', applyFilters(dedupe(offGlobal), dateStr, kwGov ? keyword : null));
        } else {
          renderItems('sec-officials', []);
        }
      }catch(e){
        console.error(e);
        // ì‹¤íŒ¨ ì‹œì—ë„ ì„¹ì…˜ì€ ìœ ì§€ë¨
      }

      document.getElementById('meta').textContent =
        `${dateStr} ê¸°ì¤€(ì „ì¼ 15:00~ë‹¹ì¼ 14:59 KST) ì„¹ì…˜ë³„ ìƒìœ„ ${CONFIG.maxPerSection}ê±´ Â· ëŒ€ëµ ${totalShown}ê±´ í‘œì‹œ`;
    }

    /* ---------------- EXPORT ---------------- */
    function toMarkdown(){
      const dateStr = document.getElementById('dateInput').value;
      const sections = [
        'sec-gTop','sec-top','sec-healthcare','sec-economy','sec-society','sec-tech','sec-global','sec-officialsKR','sec-officials'
      ];
      const names = {
        'sec-gTop':'Google Top Stories(ko/en)', 'sec-top':'Top Stories(ê¸€ë¡œë²Œ ë³´ì •)',
        'sec-healthcare':'1) í—¬ìŠ¤ì¼€ì–´Â·ì˜ë£Œ ì‚°ì—…','sec-economy':'2) ê²½ì œÂ·ê²½ì˜ íŠ¸ë Œë“œ',
        'sec-society':'3) ì‚¬íšŒÂ·ë¬¸í™” ì´ìŠˆ','sec-tech':'4) ê¸°ìˆ Â·ë””ì§€í„¸ íŠ¸ë Œë“œ',
        'sec-global':'5) ê¸€ë¡œë²Œ ì´ìŠˆ','sec-officialsKR':'êµ­ë‚´ ê³µì‹ ë ¥ ì†ŒìŠ¤(ê¸°ê´€ ë°œí‘œ)','sec-officials':'í•´ì™¸ ê³µì‹ ë ¥ ì†ŒìŠ¤(ê¸°ê´€ ë°œí‘œ)'
      };
      const lines = [`# ë°ì¼ë¦¬ ë‰´ìŠ¤ ë¸Œë¦¬í•‘ (${dateStr})\n`];
      for(const id of sections){
        const sec = document.getElementById(id);
        const title = names[id] || sec.querySelector('h2')?.textContent?.trim() || id;
        lines.push(`## ${title}`);
        const links = [...sec.querySelectorAll('a')];
        if(!links.length){ lines.push('- (í•´ë‹¹ ì¡°ê±´ ê¸°ì‚¬ ì—†ìŒ)\n'); continue; }
        for(const a of links){
          const h3 = a.querySelector('h3')?.textContent?.trim() || a.href;
          const meta = a.querySelector('p')?.textContent?.trim() || '';
          lines.push(`- [${h3}](${a.href}) â€” ${meta}`);
        }
        lines.push('');
      }
      return lines.join('\n');
    }

    /* ---------------- BOOT ---------------- */
    const dateInput = document.getElementById('dateInput');
    const fetchBtn  = document.getElementById('fetchBtn');
    const exportBtn = document.getElementById('exportBtn');

    function init(){
      if(!dateInput.value) dateInput.value = toLocalKSTDateString(new Date());
      // ì²˜ìŒì—ë„ ì¦‰ì‹œ ë¡œë”©
      run();
      // ë²„íŠ¼ ì´ë²¤íŠ¸
      fetchBtn.addEventListener('click', run);
      exportBtn.addEventListener('click', ()=>{
        const md = toMarkdown();
        const blob = new Blob([md], {type:'text/markdown;charset=utf-8'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `ë‰´ìŠ¤ë¸Œë¦¬í•‘_${dateInput.value}.md`; a.click();
        setTimeout(()=>URL.revokeObjectURL(url), 1000);
      });
    }

    if(document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
